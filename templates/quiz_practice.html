<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', path='/favicon.ico') }}" type="image/x-icon">
    <title>Quiz Practice - {{ quiz.title }}</title>
</head>
<body>
<nav class="navbar">
    <a href="/" class="nav-link">Home</a>
</nav>
<h1>Quiz Practice - {{ quiz.title }}</h1>
<div class="container">
    <div class="quiz-info">
        <div class="quiz-details">
            <span class="class-name">{{ quiz.class_name }}</span>
            <span class="question-count" id="questionCount">Loading questions...</span>
        </div>
        <button class="add-btn" onclick="reloadQuestions()">Reload Quiz</button>
    </div>

    <div id="quizContainer"></div>
</div>

<script>
    let aiAvailable = false;
    
    async function fetchQuiz(quizId) {
        const response = await fetch(`/api/quizzes/${quizId}`);
        if (response.ok) {
            const data = await response.json();
            displayQuestions(data);
        } else {
            alert("Failed to load quiz");
        }
    }

    async function checkAIAvailability() {
        try {
            const response = await fetch('/api/ai/status');
            const status = await response.json();
            aiAvailable = status.ai_available;
            return aiAvailable;
        } catch (error) {
            console.error('Error checking AI availability:', error);
            aiAvailable = false;
            return false;
        }
    }

    function selectAnswer(index, selected) {
        const data = JSON.parse(localStorage.getItem('questions'));
        const feedback = document.getElementById(`feedback${index}`);
        const question = data[index];
        const correctAnswer = question.correct_answer;
        
        let feedbackHtml = `Selected: ${selected}<br>Correct: ${correctAnswer}<br>`;
        if (selected === correctAnswer) {
            feedbackHtml += `<span class="correct">CORRECT</span>`;
        } else {
            feedbackHtml += `<span class="wrong">WRONG</span>`;
        }
        
        // Add explain button if AI is available
        if (aiAvailable) {
            feedbackHtml += `<br><button class="explain-btn" onclick="explainAnswer(${index}, '${selected}')" data-question="${index}"> Explain Answer</button>`;
        }
        
        feedback.innerHTML = feedbackHtml;
    }

    function checkFillBlankAnswer(index) {
        const data = JSON.parse(localStorage.getItem('questions'));
        const question = data[index];
        const feedback = document.getElementById(`feedback${index}`);
        
        if (question.question_type === 'fill_blank') {
            // Get all input values for this question
            const inputs = document.querySelectorAll(`input[data-question="${index}"]`);
            const userAnswers = Array.from(inputs).map(input => input.value.toLowerCase().trim());
            
            // Parse acceptable answers (options contain all acceptable answers for fill_blank)
            const acceptableAnswers = question.options.map(ans => ans.toLowerCase().trim());
            
            // Check if all blanks are filled correctly
            let allCorrect = true;
            let resultHtml = '';
            
            if (userAnswers.length === 1) {
                // Single blank
                const userAnswer = userAnswers[0];
                const isCorrect = acceptableAnswers.includes(userAnswer);
                allCorrect = isCorrect;
                
                resultHtml = `Your answer: "${userAnswer}"<br>`;
                resultHtml += `Acceptable answers: ${acceptableAnswers.join(', ')}<br>`;
                
                if (isCorrect) {
                    resultHtml += `<span class="correct">CORRECT</span>`;
                } else {
                    resultHtml += `<span class="wrong">WRONG</span>`;
                }
            } else {
                // Multiple blanks - for now, treat as single answer check
                // Future enhancement: handle multiple distinct blanks
                const userAnswer = userAnswers.join(' ');
                const isCorrect = acceptableAnswers.some(ans => ans.includes(userAnswer.toLowerCase()));
                allCorrect = isCorrect;
                
                resultHtml = `Your answers: ${userAnswers.join(', ')}<br>`;
                resultHtml += `Acceptable answers: ${acceptableAnswers.join(', ')}<br>`;
                
                if (isCorrect) {
                    resultHtml += `<span class="correct">CORRECT</span>`;
                } else {
                    resultHtml += `<span class="wrong">WRONG</span>`;
                }
            }
            
            // Add explain button if AI is available
            if (aiAvailable) {
                const userAnswerString = userAnswers.length === 1 ? userAnswers[0] : userAnswers.join(' ');
                resultHtml += `<br><button class="explain-btn" onclick="explainAnswer(${index}, '${userAnswerString}')" data-question="${index}"> Explain Answer</button>`;
            }
            
            feedback.innerHTML = resultHtml;
        }
    }

    function handleEnterKey(event, questionIndex) {
        // Check if Enter key was pressed (key code 13)
        if (event.key === 'Enter' || event.keyCode === 13) {
            event.preventDefault(); // Prevent form submission or other default behavior
            checkFillBlankAnswer(questionIndex);
        }
    }

    function displayQuestions(data) {
        localStorage.setItem('questions', JSON.stringify(data.questions));
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';

        // Update question count
        document.getElementById('questionCount').textContent = `${data.questions.length} question${data.questions.length !== 1 ? 's' : ''}`;

        data.questions.forEach((item, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';
            questionDiv.innerHTML = `
                <div class="question-header">
                    <h3>Question ${index + 1}</h3>
                    <span class="question-type-badge">${item.question_type.replace('_', ' ')}</span>
                </div>
                ${generateQuestionContent(item, index)}
                <div id="feedback${index}" class="feedback-area"></div>
            `;
            container.appendChild(questionDiv);
        });
    }

    function generateQuestionContent(question, index) {
        if (question.question_type === 'fill_blank') {
            return generateFillBlankQuestion(question, index);
        } else {
            return generateMultipleChoiceQuestion(question, index);
        }
    }

    function generateFillBlankQuestion(question, index) {
        // Replace {blank} tokens with input fields
        let questionText = question.question;
        let blankCounter = 0;
        
        // Replace each {blank} with a numbered input field
        questionText = questionText.replace(/{blank}/g, () => {
            return `<input type="text" class="blank-input" data-question="${index}" data-blank="${blankCounter++}" placeholder="___" onkeypress="handleEnterKey(event, ${index})">`;
        });
        
        return `
            <div class="fill-blank-question">
                <p class="question-text">${questionText}</p>
                <button class="check-btn" onclick="checkFillBlankAnswer(${index})">Check Answer</button>
            </div>
        `;
    }

    function generateMultipleChoiceQuestion(question, index) {
        return `
            <div class="multiple-choice-question">
                <p class="question-text">${question.question}</p>
                <div class="options-container">
                    ${question.options.map(option => 
                        `<button class="option-btn" onclick="selectAnswer(${index}, '${option}')">${option}</button>`
                    ).join('')}
                </div>
            </div>
        `;
    }

    async function explainAnswer(questionIndex, userAnswer) {
        const data = JSON.parse(localStorage.getItem('questions'));
        const question = data[questionIndex];
        const button = document.querySelector(`button[data-question="${questionIndex}"]`);
        
        // Update button to show loading
        const originalText = button.textContent;
        button.textContent = ' Generating...';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/ai/explain-answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question.question,
                    question_type: question.question_type,
                    correct_answer: question.correct_answer,
                    options: question.options,
                    user_answer: userAnswer
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                showExplanation(questionIndex, result.explanation);
            } else {
                const error = await response.json();
                alert(`Failed to generate explanation: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error getting explanation:', error);
            alert('Error getting explanation from AI');
        } finally {
            // Restore button
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    function showExplanation(questionIndex, explanation) {
        const feedback = document.getElementById(`feedback${questionIndex}`);
        
        // Create or update explanation area
        let explanationDiv = feedback.querySelector('.ai-explanation');
        if (!explanationDiv) {
            explanationDiv = document.createElement('div');
            explanationDiv.className = 'ai-explanation';
            feedback.appendChild(explanationDiv);
        }
        
        explanationDiv.innerHTML = `
            <div class="explanation-header">
                <span class="ai-icon"></span>
                <strong>AI Explanation</strong>
            </div>
            <div class="explanation-content">${explanation}</div>
        `;
    }

    function reloadQuestions() {
        const quizId = {{ quiz.id | tojson }};
        fetchQuiz(quizId);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // Check AI availability first
        await checkAIAvailability();
        
        // Then load the quiz
        const quizId = {{ quiz.id | tojson }};
        fetchQuiz(quizId);
    });
</script>
</body>
</html>
